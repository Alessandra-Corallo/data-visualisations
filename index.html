<!DOCTYPE html>
<meta charset="utf-8">
<style>
.heading {
    font-family: sans-serif;
    margin-left: 12px;
    margin-bottom: 0px;
    margin-top: 5px;
    font-size: 0.8em;
}

.label {
    font-weight: bold;
}


#my_dataviz {
    display: inline-block;
    position: relative;
    width: 50%;
    padding-bottom: 100%; /* aspect ratio */
    vertical-align: top;
    overflow: hidden;
}

.svg-content-responsive {
    display: inline-block;
    position: absolute;
    top: 10px;
    left: 0;
}
</style>

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz">
</div>

<script>

function wrap(text, width) {
    text.each(function () {
        var text = d3.select(this),
            words = text.text().split(/\s+/).reverse(),
            word,
            line = [],
            lineNumber = 0,
            lineHeight = 1.1, // ems
            x = text.attr("x"),
            y = text.attr("y"),
            dy = 0, //parseFloat(text.attr("dy")),
            tspan = text.text(null)
                        .append("tspan")
                        .attr("x", x)
                        .attr("y", y)
                        .attr("dy", dy + "em");
        while (word = words.pop()) {
            line.push(word);
            tspan.text(line.join(" "));
            if (tspan.node().getComputedTextLength() > width) {
                line.pop();
                tspan.text(line.join(" "));
                line = [word];
                tspan = text.append("tspan")
                            .attr("x", x)
                            .attr("y", y)
                            .attr("dy", ++lineNumber * lineHeight + dy + "em")
                            .text(word);
            }
        }
    });
}

function unique(x) {
    return x.reverse().filter(function (e, i, x) {return x.indexOf(e, i+1) === -1;}).reverse();
}

var base_url = "https://openspending.org"
var url = base_url + "/api/3/cubes/b9d2af843f3a7ca223eea07fb608e62a:estimates-of-national-expenditure-2019-20-uploaded-2019-02-20t1910/aggregate/?pagesize=10000&cut=budget_phase.budget_phase%3AMain+appropriation%7Cfinyear.finyear%3A2019%7Cvoteno.department%3AWater+and+Sanitation&drilldown=progno.programme%7Csprogno.subprogramme"

// set the dimensions and margins of the graph
var margin = {top: 10, right: 10, bottom: 10, left: 10},
  width = 445 - margin.left - margin.right,
  height = 445 - margin.top - margin.bottom;
var wrap_width = 180;

// append the svg object to the body of the page
var svg = d3.select("#my_dataviz")
    .append("svg")
        //.attr("width", width + margin.left + margin.right)
        //.attr("height", height + margin.top + margin.bottom)
        .attr("preserveAspectRatio", "xMinYMin meet")
        .attr("viewBox", "0 0 600 400")
        .classed("svg-content-responsive", true)
        .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var labels = svg.append("g");
var treemap = svg.append("g");

var programme_label = labels.append("text")
    .classed("heading", true)
    .classed("programme", true);

var subprogramme_label = labels
    .append("text")
        .attr("dy", "1.2em")
        .classed("heading", true)
        .classed("subprogramme", true)

var amount_label = labels.append("text")
    .attr("dy", "2.4em")
    .classed("heading", true)
    .classed("amount", true);

var fmt = function(x) { 
    return "R" + d3.format(",.0f")(x);
}

var color_brewer = ['#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#e31a1c','#fdbf6f','#ff7f00','#cab2d6','#6a3d9a','#ffff99','#b15928']

// read json data
var createColorMap = function(data) {
    color_map = {};
    var programmes = unique(data.map(function(d) {
        return d["progno.programme"]
    }));

    programmes.map(function(d, idx) {
        color_map[d] = color_brewer[idx];
    });

    return color_map;
}
d3.json(url, function(data) {
  data = data.cells;
  color_map = createColorMap(data);

  var nested_data = d3.nest()
    .key(function(d) { return d["progno.programme"]})
    .entries(data)

  var root = d3.hierarchy(
      {values:nested_data},
      function(d) { return d.values }
  )
  .sum(function(d) { return d["value.sum"]})

  // Then d3.treemap computes the position of each element of the hierarchy
  d3.treemap()
    .size([width, height])
    .padding(2)
    (root)

  treemap.attr("transform", "translate(0, 30)");
  // use this information to add rectangles:
  var rects = treemap
    .selectAll("rect")
    .data(root.leaves())
    .enter()
    .append("rect")
      .attr('x', function (d) { return d.x0; })
      .attr('y', function (d) { return d.y0; })
      .attr('width', function (d) { return d.x1 - d.x0; })
      .attr('height', function (d) { return d.y1 - d.y0; })
      .style("stroke", "black")
      .style("fill", function(d) {
          return color_map[d.data["progno.programme"]];
       })
      .on("mouseover", function(d) {
          subprogramme_label.text("Subprogramme: " + d.data["sprogno.subprogramme"]);
          programme_label.text("Programme: " + d.data["progno.programme"]);
          amount_label.text("Amount: " + fmt(d.value));
      })

  // and to add the text labels
  treemap
    .selectAll("text")
    .data(root.leaves())
    .enter()
    .append("text")
      .attr("x", function(d){ return d.x0+5})    // +10 to adjust position (more right)
      .attr("y", function(d){ return d.y0+20})    // +20 to adjust position (lower)
      .text(function(d){
          var total = root.value;
          var min_ratio = 0.1; // TODO move this further up
          if (d.value / total > min_ratio) {
              return d.data["sprogno.subprogramme"]
          }
          return "";
      })
      // TODO fix this - shouldn't be hardcoded
      .call(wrap, wrap_width)
      .attr("font-size", "15px")
      .attr("fill", "white")
})
</script>
